<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gifsicle-wasm-browser-demo</title>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
            padding: 20px;
            min-height: 100vh;
            position: relative;
        }

        body.working .bg {
            /* content: 'üî• Running...'; */
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-size: 63px;
            line-height: 70px;
            font-weight: 900;
            background-color: rgba(100, 100, 100, 0.8);
            color: red;
        }

        .red {
            color: red;
        }

        .green {
            color: green;
        }

        .flex {
            display: flex;
            align-items: center;
        }

        .flex>div p {
            font-size: 22px;
            text-align: center;
        }



        .command {
            width: 100%;
            border: 3px solid rgb(25, 30, 58);
            background-color: rgb(22, 27, 150);
            height: 50px;
            font-size: 22px;
            text-indent: 20px;
            color: rgb(241, 235, 34);
        }

        .imgBox {
            display: flex;
            align-items: center;
        }

        .imgBox img {
            width: auto;
            max-width: calc((100vw - 500px)/2);
            padding: 10px;
        }

        button {
            flex-shrink: 0;
            height: 50px;
            width: 30%;
            max-width: 200px;
            font-size: 22px;
            cursor: pointer;
            margin-left: 20px;
            background-color: rgb(241, 235, 34);
        }

        code {
            font-size: 22px;
            color: hotpink;
        }

        p {
            font-size: 18px;
            line-height: 21px;
        }

        .m_t_10 {
            margin-top: 10px;
        }

        .minButton {
            width: 80px;
            height: 34px;
        }

        svg {
            display: none;
        }
    </style>
</head>

<body class="">
    <div class="" style="display:flex">
        <div style="width:100%; padding-right:30px;">
            <h1>gifsicle-wasm-browser-demo</h1>
            <p>worker
                <input type="checkbox" checked style="zoom:2">
            </p>

            <p>command:</p>
            <div class="flex">
                <input class="command" name="" type="text" value="-O3 --lossy=80"></input>

                <button class="button mainRun">Run</button>
            </div>
            <p>input data:</p>
            dorp gif here or
            <input id="file" type="file" accept=".gif">

            <!-- <h2>f12 Open the console to view information</h2> -->
            <div class="printConsole">

            </div>
            <br>
            <div class="history">
                <h3>history</h3>

            </div>
        </div>
        <!--  -->
        <div style="width:500px;flex-shrink: 0;">
            <h3>How do?</h3>
            <p>
                01. setting command <br> 02. drop an gif file <br> 03. change command <br> 04. click run
            </p>
            <br>
            <h3>you can try these command</h3>
            <p>
                <button class="minButton">run</button>
                <code>
                    -O1 --interlace
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O2 --colors 2
                </code-o>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O3 --resize _x100
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    --scale 0.5x_
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O3 --lossy=60
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O3 --lossy=200
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O3 --lossy=200 --colors 128
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O3 --lossy=80 --colors 200
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O3 --lossy=80 --colors 160
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O3 --lossy=80
                </code>
            </p>
            <p class="m_t_10">
                <button class="minButton">run</button>
                <code>
                    -O3 --lossy=80
                </code>
            </p>
        </div>
    </div>

    <div class="bg">

        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200px" height="200px"
            viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
            <g>
                <circle cx="60" cy="50" r="4" fill="#e15b64">
                    <animate attributeName="cx" repeatCount="indefinite" dur="1s" values="95;35" keyTimes="0;1"
                        begin="-0.67s"></animate>
                    <animate attributeName="fill-opacity" repeatCount="indefinite" dur="1s" values="0;1;1"
                        keyTimes="0;0.2;1" begin="-0.67s"></animate>
                </circle>
                <circle cx="60" cy="50" r="4" fill="#e15b64">
                    <animate attributeName="cx" repeatCount="indefinite" dur="1s" values="95;35" keyTimes="0;1"
                        begin="-0.33s"></animate>
                    <animate attributeName="fill-opacity" repeatCount="indefinite" dur="1s" values="0;1;1"
                        keyTimes="0;0.2;1" begin="-0.33s"></animate>
                </circle>
                <circle cx="60" cy="50" r="4" fill="#e15b64">
                    <animate attributeName="cx" repeatCount="indefinite" dur="1s" values="95;35" keyTimes="0;1"
                        begin="0s"></animate>
                    <animate attributeName="fill-opacity" repeatCount="indefinite" dur="1s" values="0;1;1"
                        keyTimes="0;0.2;1" begin="0s"></animate>
                </circle>
            </g>
            <g transform="translate(-15 0)">
                <path d="M50 50L20 50A30 30 0 0 0 80 50Z" fill="#f8b26a" transform="rotate(90 50 50)"></path>
                <path d="M50 50L20 50A30 30 0 0 0 80 50Z" fill="#f8b26a">
                    <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
                        values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1"></animateTransform>
                </path>
                <path d="M50 50L20 50A30 30 0 0 1 80 50Z" fill="#f8b26a">
                    <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
                        values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1"></animateTransform>
                </path>
            </g>
        </svg>
        <span>
            üî• Running...
        </span>
    </div>

</body>
<script src="../dist/gifsicle-wasm-browser.js"></script>
<script>
    let gifUrl = './2.gif'
    let save = {
        url: null,
    }
    let throttle = {
        val: null,
        run(fn, ms = 600) {
            clearTimeout(this.val);
            this.val = setTimeout(() => {
                fn();
            }, ms);
        },
    }

    pageEvent()
    // start(gifUrl,getCommand())

    async function start(url, command) {
        document.querySelector('.printConsole').innerHTML = `<h2 class="red">üî• Running...</h2>`
        document.querySelector('body').classList.add('working')
        throttle.run(async () => {
            let time = new Date()
            save.url = url
            // document.querySelectorAll('button').forEach(e=>e.style.display='none')
            /////////////////////////

            let file = await fetch(url).then(file => file.arrayBuffer()).then(buf => {
                return {
                    blob: new Blob([buf]),
                    buf: buf
                }
            })
            let isWorker = document.querySelector('[type="checkbox"]').checked
            ////////////////////// worker
            if (isWorker) {
                let gifsicleWorker = new Worker('../dist/worker.js');
                // let gifsicleWorker = new Worker('../dist/gifsicleWorkerAll.js');
                // ÂºÄÂßãËΩ¨Êç¢
                gifsicleWorker.postMessage({
                    buffer: file.buf,
                    command: command
                });
                // ÈáèÂåñËΩ¨Êç¢
                gifsicleWorker.onmessage = function (e) {
                    if (!e.data) {
        document.querySelector('.printConsole').innerHTML = `<h2 class="red">‚ùå‚ùå‚ùå Error!</h2>`
                        document.querySelector('body').classList.remove('working')

                        return
                    }

                    console.log(e.data);
                    let gif = e.data
                    printConsole({
                        file,
                        gif,
                        command,
                        bufferUrl: URL.createObjectURL(file.blob),
                        afterUrl: URL.createObjectURL(gif),
                        time: ((new Date() - time) / 1000).toFixed(1),
                    })
                };
                // ËΩ¨Êç¢ÈîôËØØ
                gifsicleWorker.onerror = function (e) {
                    console.error(e);
                    // res(null);
                    gifsicleWorker.terminate();
                };
            }
            ////////////////////// no worker
            else {

                let u8Data = new Uint8Array(file.buf)
                let outputU8Data = await gifsicle({
                    data: u8Data,
                    command: command
                }).catch(_ => null)
                let gif = new Blob([outputU8Data.buffer], {
                    type: 'image/gif',
                });
                ///////////////////////////
                printConsole({
                    file,
                    gif,
                    command,
                    bufferUrl: URL.createObjectURL(file.blob),
                    afterUrl: URL.createObjectURL(gif),
                    time: ((new Date() - time) / 1000).toFixed(1),
                })
            }

            /////////////////////////

        }, 300);

    }

    function history(text) {
        document.querySelector('.history').innerHTML += text
    }

    function pageEvent() {
        let body = document.querySelector('body')
        let input = document.querySelector('#file')
        ////////////////////
        body.addEventListener('drop', function (e) {
            e.preventDefault();
            body.style.border = "none"
            // console.log();
            let commandArr = document.querySelector('.command').value.split(' ').filter(f => Boolean(f))
            let url = URL.createObjectURL(e.dataTransfer.files[0])
            start(url, commandArr)
        })
        body.addEventListener('dragover', function (e) {
            e.preventDefault();
            body.style.border = "13px dotted blue"
        })

        /////////////////////
        input.addEventListener('change', function (e) {
            console.log(e, this.files[0]);
            let commandArr = document.querySelector('.command').value.split(' ').filter(f => Boolean(f))
            let url = URL.createObjectURL(this.files[0])
            start(url, commandArr)
        });
        ////////////////////////
        document.querySelectorAll('.minButton').forEach(e => {
            let lll = e
            e.addEventListener("click", _ => {
                let c = e.nextSibling.nextSibling.innerText
                c = c.split(' ').filter(f => Boolean(f))
                start(save.url ? save.url : gifUrl, c)

            });
        })
        document.querySelector('.mainRun').addEventListener("click", e => {
            let commandArr = document.querySelector('.command').value.split(' ').filter(f => Boolean(f))
            console.log(commandArr);
            start(save.url ? save.url : gifUrl, commandArr)
        });


    }

    function getCommand() {
        let command = document.querySelector('.command')
        let commandArr = command.value.split(' ').filter(f => Boolean(f))
        console.log(commandArr);
        return commandArr

    }

    function printConsole(obj = {}) {
        let {
            file,
            gif,
            bufferUrl,
            afterUrl,
            time,
            command,
        } = obj
        let beforeSize = (file.blob.size / 1000 / 1000).toFixed(3)
        let afterSize = (gif.size / 1000 / 1000).toFixed(3)
        history(`${beforeSize}Mb -> ${afterSize}Mb  ${time}s  [${command.map(m=>`'${m}'`).join(' ')}] <br />`)

        document.querySelector('body').classList.remove('working')
        document.querySelector('.printConsole').innerHTML = `
            <br/>
            <br/>
            <h2 class="green">üéâ Done! time: ${time} s</h2>
            <br/>
            <div class="imgBox">
                <div>
                    <p>Before ${beforeSize }Mb</p>
                    <p>
                        <img src="${bufferUrl}" />
                    </p>
                </div>
                <h2>üëâ</h2>
                <div>
                    <p>After ${afterSize} Mb</p>
                    <p>
                        <img src="${afterUrl}" />
                    </p>
                </div>
            </div>
        `
    }
</script>

</html>