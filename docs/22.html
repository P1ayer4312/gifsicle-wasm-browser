<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

</body>
<style>
    img {
        outline: 1px dashed red;
        margin: 3px;
    }
</style>
<script>
    (async function name(params) {
        // let buffer = await fetch('./11.gif').then(file => file.arrayBuffer())
        // let out1 = await gif({
        //     inputFiles: [
        //         {
        //             file: buffer,
        //             name: "111.gif",
        //         }
        //     ],
        //     command: '111.gif -o /out/out.gif ',
        // })
        // let buffer2 = await fetch(URL.createObjectURL(out1[0])).then(file => file.arrayBuffer())
        // let out2 = await gif({
        //     inputFiles: [
        //         {
        //             file: buffer2,
        //             name: "111.gif",
        //         }
        //     ],
        //     command: '-e -U 111.gif -o /out/out.gif',
        // })


        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


        // let gif1 = await fetch('./1.gif').then(file => file.arrayBuffer())
        // let gif2 = await fetch('./2.gif').then(file => file.arrayBuffer())
        // let gif3 = await fetch('./3.gif').then(file => file.arrayBuffer())
        // // let gif4 = await fetch('./7.gif').then(file => file.arrayBuffer())
        // let out1 = await gif({
        //     inputFiles: [
        //         {
        //             file: gif1,
        //             name: "1.gif",
        //         },
        //         {
        //             file: gif2,
        //             name: "2.gif",
        //         },
        //         {
        //             file: gif3,
        //             name: "3.gif",
        //         }
        //     ],
        //     command: '--merge 1.gif 2.gif 3.gif -o /out/out.gif',
        // })


        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




        // let g1 = await fetch('./1.gif').then(file => file.arrayBuffer())
        // let g2 = await fetch('./2.gif').then(file => file.arrayBuffer())
        // let g3 = await fetch('./3.gif').then(file => file.arrayBuffer())
        // let g4 = await fetch('./4.gif').then(file => file.arrayBuffer())
        // let g5 = await fetch('./5.gif').then(file => file.arrayBuffer())
        // let g6 = await fetch('./6.gif').then(file => file.arrayBuffer())
        // let g7 = await fetch('./7.gif').then(file => file.arrayBuffer())
        // let g8 = await fetch('./8.gif').then(file => file.arrayBuffer())
        // let g9 = await fetch('./9.gif').then(file => file.arrayBuffer())
        // let out1 = await gif({
        //     inputFiles: [
        //         {
        //             file: buffer,
        //             name: "111.gif",
        //         }
        //     ],
        //     command: '--batch 111.gif -o /out/out.gif ',
        // })
        // let buffer2 = await fetch(URL.createObjectURL(out1[0])).then(file => file.arrayBuffer())
        // let out2 = await gif({
        //     inputFiles: [
        //         {
        //             file: buffer2,
        //             name: "111.gif",
        //         }
        //     ],
        //     command: '-e -U 111.gif -o /out/out.gif',
        // })


        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



        let g1 = await fetch('./10.gif').then(file => file.arrayBuffer())
        let out1 = await gif({
            inputFiles: [
                {
                    file: g1,
                    name: "1.gif",
                },
            ],
            command: '--crop-transparency  1.gif -o /out/out.gif',
        })
        let buffer2 = await out1[0].arrayBuffer()
        let out2 = await gif({
            inputFiles: [
                {
                    file: buffer2,
                    name: "1.gif",
                },
            ],
            command: '--rotate-180  1.gif -o /out/out.gif',
        })
        let buffer3 = await out2[0].arrayBuffer()
        let out3 = await gif({
            inputFiles: [
                {
                    file: buffer3,
                    name: "1.gif",
                },
            ],
            command: '--rotate-180 --crop-transparency --dither --use-col=bw 1.gif  -o /out/out.gif',
        })

    })()

    function gif(obj) {
        return new Promise(async (res, rej) => {
            let {
                inputFiles = [],
                command = '',
                outputFormat = 'gif',
                workerUrl = '../dist/gifsicle2222.js',
            } = obj
            console.log(obj);


            let newCommand = command.split(' ').filter(f => Boolean(f))
            // newCommand.unshift(`--no-warnings`, `--no-app-extensions`)
            console.log(newCommand, inputFiles, workerUrl);

            let myWorker = new Worker(workerUrl);
            myWorker.postMessage({
                inputFiles: inputFiles,
                command: newCommand
            });
            // 量化转换
            myWorker.onmessage = async function (e) {
                if (!e.data) {
                    myWorker.terminate();
                    res(null);
                    return
                }
                console.log(e.data);
                if (outputFormat === 'gif') {
                    let outArr = []
                    for (let index = 0; index < e.data.length; index++) {
                        const element = e.data[index];
                        let gif = new Blob([element], { type: 'image/gif' })
                        let url = URL.createObjectURL(gif)
                        outArr.push(gif)
                        document.querySelector('body').insertAdjacentHTML('beforeend', `<img src=${url}>`)
                    }
                    res(outArr)
                    console.log(outArr);
                }else if(outputFormat === 'txt'){
                    let outArr = []
                    for (let index = 0; index < e.data.length; index++) {
                        const element = e.data[index];
                        let blob = new Blob([element], { type: 'text/plain' })
                        let text = await blob.text()
                        outArr.push(blob)
                        // console.log();
                        // text = JSON.stringify(text)
                        text = text.split('\n').map(m=>m+'<br>')
                        document.querySelector('body').insertAdjacentHTML('beforeend', `${text}`)
                    }
                    res(outArr)
                    console.log(outArr);
                }
            };
            // 转换错误
            myWorker.onerror = function (e) {
                console.error(e);
                myWorker.terminate();
                res(null);
            };
        })
    }
</script>

</html>